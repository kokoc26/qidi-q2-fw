name: Check and Download Firmware

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * *"
jobs:
  check_and_update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install necessary tools
        run: sudo apt-get install -y jq p7zip-full tar

      - name: Fetch Firmware Info and Parse JSON
        id: firmware_info
        run: |
          API_URL="https://api.qidi3dprinter.com/code/x_q_2_version_info"
          FIRMWARE_JSON=$(curl -s "$API_URL")
          VERSION=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.version')
          SIZE=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.size')
          DATE=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.date')
          DESCRIPTION_RU=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.description.ru_RU')
          DESCRIPTION_EN=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.description.en_US')

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SIZE=$SIZE" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "description_ru<<EOF_RU" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_RU" | tr '\r' '\n' | sed 's/^/  - /' >> $GITHUB_OUTPUT
          echo "EOF_RU" >> $GITHUB_OUTPUT
          echo "description_en<<EOF_EN" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_EN" | tr '\r' '\n' | sed 's/^/  - /' >> $GITHUB_OUTPUT
          echo "EOF_EN" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_RU" | tr '\r' '\n' > firmware_description_ru.txt
          echo "$DESCRIPTION_EN" | tr '\r' '\n' > firmware_description_en.txt

      - name: Check if release/tag exists
        id: release_check
        run: |
          TAG_EXISTS=$(git tag -l ${{ env.VERSION }})
          if [ -n "$TAG_EXISTS" ]; then
            echo "Release for ${{ env.VERSION }} already exists. Skipping all next steps."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Release for ${{ env.VERSION }} does not exist. Proceeding."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create working directories
        if: steps.release_check.outputs.skip == 'false'
        run: |
          mkdir -p work/q2
          mkdir -p work/soc
          mkdir -p firmware

      - name: Download Firmware
        if: steps.release_check.outputs.skip == 'false'
        run: |
          VERSION=${{ env.VERSION }}
          ZIP_FILENAME="Q2_${VERSION}.zip"
          DOWNLOAD_URL="https://download_aws.qidi3dprinter.com/QD_Q2/${ZIP_FILENAME}"
          echo "Downloading firmware $ZIP_FILENAME..."
          curl -L -o "$ZIP_FILENAME" "$DOWNLOAD_URL"
          echo "ZIP_FILENAME=$ZIP_FILENAME" >> $GITHUB_ENV

      - name: Unzip main archive
        if: steps.release_check.outputs.skip == 'false'
        run: |
          ZIP_FILENAME=${{ env.ZIP_FILENAME }}
          7z x "$ZIP_FILENAME" -o"work/q2"

      - name: Find and unzip inner SOC archive
        if: steps.release_check.outputs.skip == 'false'
        id: find_soc
        run: |
          SOC_ARCHIVE=$(find work/q2 -type f -name "QD_Q2_SOC*" -print -quit)
          if [ -z "$SOC_ARCHIVE" ]; then
            echo "::error::SOC archive (QD_Q2_SOC*) not found."
            exit 1
          fi
          echo "Found SOC archive: $SOC_ARCHIVE"
          7z x "$SOC_ARCHIVE" -o"work/soc"

      - name: Extract data.tar content
        if: steps.release_check.outputs.skip == 'false'
        run: |
          if [ ! -f work/soc/data.tar ]; then
            echo "::error::data.tar not found in work/soc."
            exit 1
          fi
          echo "Extracting data.tar..."
          tar -xf work/soc/data.tar -C firmware/

      - name: Configure Git and Commit changes
        if: steps.release_check.outputs.skip == 'false'
        run: |
          VERSION=${{ env.VERSION }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add firmware
          if [ -z "$(git diff --cached --name-only)" ]; then
            echo "No changes were staged for commit in 'firmware/' directory. Skipping commit and push."
            exit 0
          fi
          git commit firmware -m "chore(firmware): Update Qidi Q2 firmware to $VERSION"
          git push

      - name: Generate Direct Asset Link
        id: link_gen
        if: steps.release_check.outputs.skip == 'false'
        run: |
          REPO_NAME=${{ github.repository }}
          TAG_NAME=${{ env.VERSION }}
          ZIP_FILENAME=${{ env.ZIP_FILENAME }}
          RELEASE_ASSET_URL="https://github.com/${REPO_NAME}/releases/download/${TAG_NAME}/${ZIP_FILENAME}"
          echo "RELEASE_ASSET_URL=$RELEASE_ASSET_URL" >> $GITHUB_ENV

      - name: Update READMEs
        if: steps.release_check.outputs.skip == 'false'
        run: |
          VERSION=${{ env.VERSION }}
          SIZE=${{ env.SIZE }}
          DATE=${{ env.DATE }}
          RELEASE_ASSET_URL=${{ env.RELEASE_ASSET_URL }}
          DESCRIPTION_RU=$(cat firmware_description_ru.txt)
          DESCRIPTION_EN=$(cat firmware_description_en.txt)
          ROOT_README_FILE="README.md"
          CHANGELOG_HEADER_RU="## Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ (Changelog)"

          if [ ! -f "$ROOT_README_FILE" ]; then
              echo "# ÐŸÑ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ QIDI Q2" > "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "[![QIDI RUSSIAN WIKI](https://img.shields.io/badge/QIDI%20RUSSIA%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi-russia.ru/ru/Q2/)" >> "$ROOT_README_FILE"
              echo "[![QIDI WIKI](https://img.shields.io/badge/QIDI%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi3d.com/en/Q2/)" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "[English Version](./README.en.md) ðŸ‡ºðŸ‡¸" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "## Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "> [!IMPORTANT]" >> "$ROOT_README_FILE"
              echo "> ÐŸÑ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸ÑÑ‚Ñ€ÑƒÑ†Ð¸ÑÐ¼ Ð¸Ð· [Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ wiki QIDI Q2](https://wiki.qidi3d.com/en/Q2/firmware-update)." >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "> [!NOTE]" >> "$ROOT_README_FILE"
              echo "> Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð², Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ Ð² `QD_Update` Ð¸ Ð¿Ð¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ ÐµÑ‘ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð²Ð°ÑˆÐµÐ¹ Ñ„Ð»ÐµÑˆÐºÐ¸." >> "$ROOT_README_FILE"
              echo "> Ð—Ð°Ñ‚ÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ñ„Ð»ÐµÑˆÐºÑƒ Ðº Ð¿Ñ€Ð¸Ð½Ñ‚ÐµÑ€Ñƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸ÑÑ‚ÑƒÐ¿Ð¸Ñ‚ÑŒ Ðº Ð¾Ñ„Ð»Ð°Ð¹Ð½ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ." >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "---" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "$CHANGELOG_HEADER_RU" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
          fi

          awk -v AWK_VAR="$CHANGELOG_HEADER_RU" '$0 == AWK_VAR {exit} {print}' "$ROOT_README_FILE" > README_HEADER_TEMP
          awk -v AWK_VAR="$CHANGELOG_HEADER_RU" '$0 == AWK_VAR {found=1; next} {if (found) print}' "$ROOT_README_FILE" > README_CHANGELOG_TEMP

          DOWNLOAD_LINK_UNIVERSAL_RU="[Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð² ($SIZE)](${RELEASE_ASSET_URL})"

          {
            cat README_HEADER_TEMP
            echo ""
            echo "$CHANGELOG_HEADER_RU"
            echo ""
            echo "### $VERSION - $DATE"
            echo ""
            echo "#### Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ:"
            echo ""
            echo "- $DOWNLOAD_LINK_UNIVERSAL_RU"
            echo ""
            echo "#### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:"
            echo ""
            echo "$DESCRIPTION_RU" | sed 's/^/  - /'
            echo ""
            cat README_CHANGELOG_TEMP  
          } > README_TEMP && mv README_TEMP "$ROOT_README_FILE"

          ROOT_README_EN_FILE="README.en.md"
          CHANGELOG_HEADER_EN="## Changelog"

          if [ ! -f "$ROOT_README_EN_FILE" ]; then
              echo "# QIDI Q2 Firmware" > "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "[![QIDI RUSSIAN WIKI](https://img.shields.io/badge/QIDI%20RUSSIA%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi-russia.ru/ru/Q2/)" >> "$ROOT_README_EN_FILE"
              echo "[![QIDI WIKI](https://img.shields.io/badge/QIDI%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi3d.com/en/Q2/)" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "[Ð ÑƒÑÑÐºÐ°Ñ Ð²ÐµÑ€ÑÐ¸Ñ](./README.md) ðŸ‡·ðŸ‡º" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "## Download Instruction" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "> [!IMPORTANT]" >> "$ROOT_README_EN_FILE"
              echo "> Before updating, please follow the instructions on the [official QIDI Q2 wiki](https://wiki.qidi3d.com/en/Q2/firmware-update)." >> "$ROOT_README_EN_FILE" 
              echo "" >> "$ROOT_README_EN_FILE"
              echo "> [!NOTE]" >> "$ROOT_README_EN_FILE"
              echo "> Download the archive, rename the folder to `QD_Update` after extraction, and place it in the root directory of your USB device." >> "$ROOT_README_EN_FILE"
              echo "> Then connect the USB device to the printer to start the offline update." >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "---" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "$CHANGELOG_HEADER_EN" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
          fi

          awk -v AWK_VAR="$CHANGELOG_HEADER_EN" '$0 == AWK_VAR {exit} {print}' "$ROOT_README_EN_FILE" > README_EN_HEADER_TEMP
          awk -v AWK_VAR="$CHANGELOG_HEADER_EN" '$0 == AWK_VAR {found=1; next} {if (found) print}' "$ROOT_README_EN_FILE" > README_EN_CHANGELOG_TEMP

          DOWNLOAD_LINK_UNIVERSAL_EN="[Download archive ($SIZE)](${RELEASE_ASSET_URL})"

          {
            cat README_EN_HEADER_TEMP
            echo ""
            echo "$CHANGELOG_HEADER_EN"
            echo ""
            echo "### $VERSION - $DATE"
            echo ""
            echo "#### Firmware Link:"
            echo ""
            echo "- $DOWNLOAD_LINK_UNIVERSAL_EN"
            echo ""
            echo "#### Changes:"
            echo ""
            echo "$DESCRIPTION_EN" | sed 's/^/  - /'
            echo ""
            cat README_EN_CHANGELOG_TEMP
          } > README_EN_TEMP && mv README_EN_TEMP "$ROOT_README_EN_FILE"

      - name: Commit and Push README Changes
        if: steps.release_check.outputs.skip == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md README.en.md
          git commit -m "chore(release): Update Changelog with Release link for ${{ env.VERSION }}"
          git push

      - name: Create Github Release
        if: steps.release_check.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: ${{ env.VERSION }}
          body: |
            ## Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Russian):
            ${{ steps.firmware_info.outputs.description_ru }}

            ### Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ

            > [!IMPORTANT]
            > ÐŸÑ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸ÑÑ‚Ñ€ÑƒÑ†Ð¸ÑÐ¼ Ð¸Ð· [Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ wiki QIDI Q2](https://wiki.qidi3d.com/en/Q2/firmware-update).

            > [!NOTE]
            > Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð², Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ Ð² `QD_Update` Ð¸ Ð¿Ð¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ ÐµÑ‘ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð²Ð°ÑˆÐµÐ¹ Ñ„Ð»ÐµÑˆÐºÐ¸.
            > Ð—Ð°Ñ‚ÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ñ„Ð»ÐµÑˆÐºÑƒ Ðº Ð¿Ñ€Ð¸Ð½Ñ‚ÐµÑ€Ñƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸ÑÑ‚ÑƒÐ¿Ð¸Ñ‚ÑŒ Ðº Ð¾Ñ„Ð»Ð°Ð¹Ð½ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ.

            ---

            ## Changelog (English):
            ${{ steps.firmware_info.outputs.description_en }}

            ### Download Instruction

            > [!IMPORTANT]
            > Before updating, please follow the instructions on the [official QIDI Q2 wiki](https://wiki.qidi3d.com/en/Q2/firmware-update).

            > [!NOTE]
            > Download the archive, rename the folder to `QD_Update` after extraction, and place it in the root directory of your USB device.
            > Then connect the USB device to the printer to start the offline update.

          draft: false
          prerelease: false
          files: |
            ./${{ env.ZIP_FILENAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove Temporary Files
        if: steps.release_check.outputs.skip == 'false'
        run: rm -rf work firmware firmware_description_ru.txt firmware_description_en.txt ZIP_FILENAME README_HEADER_TEMP README_CHANGELOG_TEMP README_EN_HEADER_TEMP README_EN_CHANGELOG_TEMP

      - name: Inform about skip
        if: steps.release_check.outputs.skip == 'true'
        run: echo "No new firmware version found to commit."
