name: Check and Download Firmware

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install JQ
        run: sudo apt-get install -y jq

      - name: Fetch Firmware Info and Parse JSON
        id: firmware_info
        run: |
          API_URL="https://api.qidi3dprinter.com/code/x_q_2_version_info"
          FIRMWARE_JSON=$(curl -s "$API_URL")

          VERSION=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.version')
          SIZE=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.size')
          DATE=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.date')

          DESCRIPTION_RU=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.description.ru_RU')
          DESCRIPTION_EN=$(echo "$FIRMWARE_JSON" | jq -r '.firmware.description.en_US')

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SIZE=$SIZE" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV

          echo "description_ru<<EOF_RU" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_RU" | tr -d '\r' >> $GITHUB_OUTPUT
          echo "EOF_RU" >> $GITHUB_OUTPUT

          echo "description_en<<EOF_EN" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION_EN" | tr -d '\r' >> $GITHUB_OUTPUT
          echo "EOF_EN" >> $GITHUB_OUTPUT

          echo "$DESCRIPTION_RU" | tr -d '\r' > firmware_description_ru.txt
          echo "$DESCRIPTION_EN" | tr -d '\r' > firmware_description_en.txt

      - name: Check if release/tag exists
        id: release_check
        run: |
          TAG_EXISTS=$(git tag -l ${{ env.VERSION }})
          if [ -n "$TAG_EXISTS" ]; then
            echo "Release for ${{ env.VERSION }} already exists. Skipping all next steps."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Release for ${{ env.VERSION }} does not exist. Proceeding."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Firmware
        if: steps.release_check.outputs.skip == 'false'
        run: |
          VERSION=${{ env.VERSION }}
          ZIP_FILENAME="Q2_${VERSION}.zip"
          DOWNLOAD_URL="https://download_aws.qidi3dprinter.com/QD_Q2/${ZIP_FILENAME}"

          echo "Downloading firmware $ZIP_FILENAME..."
          curl -L -o "$ZIP_FILENAME" "$DOWNLOAD_URL"

          echo "ZIP_FILENAME=$ZIP_FILENAME" >> $GITHUB_ENV

      - name: Create Github Release
        if: steps.release_check.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: ${{ env.VERSION }}
          body: |
            ## Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Russian):
            ${{ steps.firmware_info.outputs.description_ru }}

            ### Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ

            Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ Ð² QD_Update Ð¸ Ð¿Ð¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ USB-Ð½Ð°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»Ñ. Ð—Ð°Ñ‚ÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ USB-Ð½Ð°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒ Ðº Ð¿Ñ€Ð¸Ð½Ñ‚ÐµÑ€Ñƒ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ.

            > [!WARNING]
            > Ð’Ð¾Ð·Ð´ÐµÑ€Ð¶Ð¸Ñ‚ÐµÑÑŒ Ð¾Ñ‚ Ð¿Ð¾Ð½Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ Ð±Ð¾Ð»ÐµÐµ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð½Ð° Ð±Ð¾Ð»ÐµÐµ Ð½Ð¸Ð·ÐºÑƒÑŽ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€Ð¸Ð²ÐµÑÑ‚Ð¸ Ðº Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ð¼ Ð² Ñ€Ð°Ð±Ð¾Ñ‚Ðµ. Ð’ÑÐµÐ³Ð´Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐ¹Ñ‚ÐµÑÑŒ Ð´Ð¾ Ñ‚Ð¾Ð¹ Ð¶Ðµ Ð¸Ð»Ð¸ Ð±Ð¾Ð»ÐµÐµ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸.


            ## Changelog (English):
            ${{ steps.firmware_info.outputs.description_en }}

            ### Download Instruction

            Download the archive file and, after unzipping it, rename the folder to QD_Update and place it in the root directory of a USB drive. Then connect the USB drive to the printer to update.

            > [!WARNING]
            > Please refrain from downgrading the firmware. Updating from a higher version to a lower version can lead to various operational issues. Always ensure to update to either the same or a higher version.

          draft: false
          prerelease: false
          files: |
            ./${{ env.ZIP_FILENAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Direct Asset Link
        id: link_gen
        if: steps.release_check.outputs.skip == 'false'
        run: |
          REPO_NAME=${{ github.repository }}
          TAG_NAME=${{ env.VERSION }}
          ZIP_FILENAME=${{ env.ZIP_FILENAME }}

          RELEASE_ASSET_URL="https://github.com/${REPO_NAME}/releases/download/${TAG_NAME}/${ZIP_FILENAME}"
          echo "RELEASE_ASSET_URL=$RELEASE_ASSET_URL" >> $GITHUB_ENV

      - name: Update READMEs and Cleanup
        if: steps.release_check.outputs.skip == 'false'
        run: |
          VERSION=${{ env.VERSION }}
          SIZE=${{ env.SIZE }}
          DATE=${{ env.DATE }}
          RELEASE_ASSET_URL=${{ env.RELEASE_ASSET_URL }}
          DESCRIPTION_RU=$(cat firmware_description_ru.txt)
          DESCRIPTION_EN=$(cat firmware_description_en.txt)

          rm -f ${{ env.ZIP_FILENAME }}

          ROOT_README_FILE="README.md"
          CHANGELOG_HEADER_RU="## Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ (Changelog)"

          if [ ! -f "$ROOT_README_FILE" ]; then
              echo "# ÐŸÑ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ QIDI Q2" > "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "[![QIDI RUSSIAN WIKI](https://img.shields.io/badge/QIDI%20RUSSIA%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi-russia.ru/ru/Q2/)" >> "$ROOT_README_FILE"
              echo "[![QIDI WIKI](https://img.shields.io/badge/QIDI%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi3d.com/en/Q2/)" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "[English Version](./README.en.md) ðŸ‡ºðŸ‡¸" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "## Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "> [!INFO]" >> "$ROOT_README_FILE"
              echo "> ÐŸÑ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐ»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸ÑÑ‚Ñ€ÑƒÑ†Ð¸ÑÐ¼ Ð¸Ð· [Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ wiki QIDI Q2](https://wiki.qidi3d.com/en/Q2/firmware-update)." >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
              echo "$CHANGELOG_HEADER_RU" >> "$ROOT_README_FILE"
              echo "" >> "$ROOT_README_FILE"
          fi

          awk -v AWK_VAR="$CHANGELOG_HEADER_RU" '$0 == AWK_VAR {exit} {print}' "$ROOT_README_FILE" > README_HEADER_TEMP
          awk -v AWK_VAR="$CHANGELOG_HEADER_RU" '$0 == AWK_VAR {found=1; next} {if (found) print}' "$ROOT_README_FILE" > README_CHANGELOG_TEMP

          DOWNLOAD_LINK_UNIVERSAL_RU="[Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð² ($SIZE)](${RELEASE_ASSET_URL})"

          {
            cat README_HEADER_TEMP
            echo ""
            echo "$CHANGELOG_HEADER_RU"
            echo ""
            echo "### $VERSION - $DATE"
            echo ""
            echo "#### Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ:"
            echo "* $DOWNLOAD_LINK_UNIVERSAL_RU"
            echo ""
            echo "#### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:"
            echo ""
            echo "$DESCRIPTION_RU" | sed 's/^/  * /'
            echo ""
            cat README_CHANGELOG_TEMP
            
          } > README_TEMP && mv README_TEMP "$ROOT_README_FILE"

          ROOT_README_EN_FILE="README.en.md"
          CHANGELOG_HEADER_EN="## Changelog"

          if [ ! -f "$ROOT_README_EN_FILE" ]; then
              echo "# QIDI Q2 Firmware" > "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "[![QIDI RUSSIAN WIKI](https://img.shields.io/badge/QIDI%20RUSSIA%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi-russia.ru/ru/Q2/)" >> "$ROOT_README_EN_FILE"
              echo "[![QIDI WIKI](https://img.shields.io/badge/QIDI%20WIKI-100000?style=for-the-badge&logo=data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMTcuMDAwMDAwcHQiIGhlaWdodD0iMzAwLjAwMDAwMHB0IiB2aWV3Qm94PSIwLDAsMjU2LDI0Mi4yNjU2MyI+PGcgZmlsbD0iI2RmZWNmMiIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iIiBzdHJva2UtZGFzaG9mZnNldD0iMCIgZm9udC1mYW1pbHk9Im5vbmUiIGZvbnQtd2VpZ2h0PSJub25lIiBmb250LXNpemU9Im5vbmUiIHRleHQtYW5jaG9yPSJub25lIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS42NTU1MiwwLjIxMjQpIHNjYWxlKDAuODA3NTcsMC44MDc1NykiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsMzAwKSBzY2FsZSgwLjEsLTAuMSkiPjxwYXRoIGQ9Ik0xMzczLDI1OTZjLTE3LC04IC0xNjUsLTkyIC0zMzAsLTE4N2MtMTY0LC05NSAtMzQxLC0xOTcgLTM5MywtMjI3Yy0xMTEsLTY0IC0xMzgsLTg1IC0xNTYsLTEyOWMtMjAsLTQ4IC0yMCwtOTk5IDAsLTEwNDZjMjEsLTUwIDU3LC03NyAyNzYsLTIwM2MxMTMsLTY0IDI5NywtMTcxIDQxMCwtMjM2bDIwNSwtMTE5bDYwLDNjNTQsNCA3MywxMiAyMDMsODdsMTQyLDg0djM0OHYzNDhsMjQsMjdjMTMsMTYgMTQ5LDEwMCAzMDIsMTg5bDI3OSwxNjFsMywxNTRjMywxNzcgLTgsMjI0IC02MSwyNjRjLTE4LDEzIC0xMTcsNzMgLTIyMiwxMzNjLTEwNCw2MCAtMjg2LDE2NSAtNDAzLDIzM2MtMjMwLDEzMyAtMjcxLDE0NyAtMzM5LDExNnpNMTczMSwyMjY5YzE0NSwtODMgMjc2LC0xNjQgMjkyLC0xODBjMzEsLTM0IDM1LC03NyAxMCwtMTA4Yy0xMCwtMTEgLTEzMCwtODUgLTI2OCwtMTY1Yy0xMzcsLTc5IC0yNjAsLTE1NSAtMjc0LC0xNjdjLTUwLC00OSAtNTEsLTU5IC01MSwtNDk5di00MTFsLTI0LC0yNGMtNDIsLTQxIC02OCwtNDEgLTE0MywxYy02NywzNyAtNTUyLDMxNyAtNTg1LDMzN2MtMzYsMjMgLTM4LDUxIC0zOCw0ODJ2NDI0bDIzLDI1YzEyLDE0IDExMCw3NSAyMTcsMTM3YzEwNyw2MiAyNjcsMTU0IDM1NSwyMDZjMTA5LDYzIDE3MCw5MyAxOTEsOTNjMjMsMCAxMDgsLTQ0IDI5NSwtMTUxeiI+PC9wYXRoPjxwYXRoIGQ9Ik0yNTEwLDE3NTdjLTI1LC0xNCAtNjAsLTMzIC03NywtNDNsLTMzLC0xOXYtMzUwYzAsLTI4OCAtMywtMzU0IC0xNCwtMzcxYy04LC0xMSAtMTQzLC05NCAtMzAwLC0xODVsLTI4NiwtMTY0di04NmMwLC03MiAzLC04OSAyMCwtMTA3YzEyLC0xMiAyNywtMjIgMzUsLTIyYzcsMCAxNSwtNSAxNywtMTBjNSwtMTUgMjQsLTQgNDA4LDIxN2MxODQsMTA3IDM0MywyMDMgMzUzLDIxNWMxNiwxOSAxNyw1NSAxNyw0NTR2NDMzbC0yMiwyNWMtMzQsMzggLTY2LDQxIC0xMTgsMTN6Ij48L3BhdGg+PC9nPjwvZz48L2c+PC9zdmc+&labelColor=1b79ce&color=1668bd)](https://wiki.qidi3d.com/en/Q2/)" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "[Ð ÑƒÑÑÐºÐ°Ñ Ð²ÐµÑ€ÑÐ¸Ñ](./README.md) ðŸ‡·ðŸ‡º" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "## Download Instruction" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
              echo "> [!INFO]" >> "$ROOT_README_EN_FILE"
              echo "> Before updating, please follow the instructions on the [official QIDI Q2 wiki](https://wiki.qidi3d.com/en/Q2/firmware-update)." >> "$ROOT_README_EN_FILE" 
              echo "" >> "$ROOT_README_EN_FILE"
              echo "$CHANGELOG_HEADER_EN" >> "$ROOT_README_EN_FILE"
              echo "" >> "$ROOT_README_EN_FILE"
          fi

          awk -v AWK_VAR="$CHANGELOG_HEADER_EN" '$0 == AWK_VAR {exit} {print}' "$ROOT_README_EN_FILE" > README_EN_HEADER_TEMP
          awk -v AWK_VAR="$CHANGELOG_HEADER_EN" '$0 == AWK_VAR {found=1; next} {if (found) print}' "$ROOT_README_EN_FILE" > README_EN_CHANGELOG_TEMP

          DOWNLOAD_LINK_UNIVERSAL_EN="[Download archive ($SIZE)](${RELEASE_ASSET_URL})"

          {
            cat README_EN_HEADER_TEMP
            echo ""
            echo "$CHANGELOG_HEADER_EN"
            echo ""
            echo "### $VERSION - $DATE"
            echo ""
            echo "#### Firmware Link:"
            echo "* $DOWNLOAD_LINK_UNIVERSAL_EN"
            echo ""
            echo "#### Changes:"
            echo ""
            echo "$DESCRIPTION_EN" | sed 's/^/  * /'
            echo ""
            cat README_EN_CHANGELOG_TEMP
            
          } > README_EN_TEMP && mv README_EN_TEMP "$ROOT_README_EN_FILE"

          rm -f firmware_description_ru.txt firmware_description_en.txt README_HEADER_TEMP README_CHANGELOG_TEMP README_EN_HEADER_TEMP README_EN_CHANGELOG_TEMP

      - name: Commit and Push README Changes
        if: steps.release_check.outputs.skip == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md README.en.md
          git commit -m "chore(release): Update Changelog with Release link for ${{ env.VERSION }}"
          git push

      - name: Inform about skip
        if: steps.release_check.outputs.skip == 'true'
        run: echo "No new firmware version found to commit."
